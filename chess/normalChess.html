<div id="board" style="width: 400px"></div>
<div id='turn'></div>
<b id="tips">Protip: The key to victory is to not lose any pieces, while taking your opponet's pieces</b>
</p>
<button onclick="board.flip();">Flip</button>
<label>Promote pawns to:</label>
<select id="defaultPromotion">
  <option value="q">Queens</option>
  <option value="b">Bishops</option>
  <option value="n">Knights</option>
  <option value="r">Rooks</option>
</select>
  
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="./chess.js"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"
        integrity="sha384-8Vi8VHwn3vjQ9eUHUxex3JSN/NFqUg3QbPyX8kWyb93+8AC/pPWTzj+nHtbC5bxD"
        crossorigin="anonymous"></script><link rel="stylesheet"
      href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css"
      integrity="sha384-q94+BZtLrkL1/ohfjR8c6L+A6qzNH9R2hBLwyoAfu3i/WCvQjzL2RQJ3uNHDISdU"
      crossorigin="anonymous">
<script>
	var chessHistory = [];
    var board, game = new Chess,
        side = 'w',
		onDragStart = function (c, d) {
            if (game.game_over() ||side !== game.turn() ){
				return false;
			}
        },
        onDrop = function (c, d) {
            var e = game.move({
                from: c,
                to: d,
                promotion: $("#defaultPromotion").val()
            });
            if(game.game_over()){
                alert("Game over");
            }
			if(e != null){
				setTimeout(function(){ board.position(game.fen(),false); }, 120);
			    $('#turn').text(`${game.turn() == 'w' ? 'White' : 'Black'} to play`);
					chessHistory.push(game.fen());
			WS.send(game.fen());
			}
			
		
            return null === e ? 'snapback' : void 0;
        }

    function cartToChess(c, d) {
        return ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h'][d] + [8, 7, 6, 5, 4, 3, 2, 1][c]
    }

    function renderBasedOnView() {
        var c = game.board();
		console.log(game.ascii());
		board.position(game.fen());
        if(!game.game_over()){
            $('#turn').text(`${game.turn() == 'w' ? 'White' : 'Black'} to play`);
        } else{
            alert("Game over");
        }
    }
    var cfg = {
        draggable: !0,
        position: 'start',
		moveSpeed: 'slow',
		snapbackSpeed: 300,
		snapSpeed: 100,
        onDragStart: onDragStart,
        onDrop: onDrop
    };
    board = ChessBoard('board', cfg);
    var WS = new WebSocket('wss://wsninjaisdown.herokuapp.com');
    WS.onmessage = function (c) {
        console.log('updating...'), c.data != 'p' ? (game = new Chess(c.data), renderBasedOnView(),chessHistory.push(c.data)) : 0;
    };
    var iesucks = x => document.write(`You lost your websocket connection. This could happen for the following reasons <br>
	1. Your internet connection is crap. <br>
	2. You're using internet explorer <br>
	3. I made a mistake in the code somewhere <br>
	It doesn't matter, here's a useless error message:<br> <pre>${JSON.stringify(x)}</pre>`)
	
    var ping;
    WS.onclose = iesucks;
    WS.onerror = iesucks;
    WS.onopen = () => { setInterval(function () { WS.send('p') }, 3000) };
    side = window.location.hash.substr(1) == 'b' ? 'b' : 'w';
	var flavor = [
		"Protip: Don't get checkmated",
		""
	]
	$("#tips").text(flavor[Math.floor(Math.random()*flavor.length)])
    renderBasedOnView();
</script>