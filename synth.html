<a id="myButton" href="#">Download <b>music</b></a>
<button id="play">Play</button>
<script>
    //To do, rewrite averaging so that other track scale back to normal volume when others are resting.
    var samplingRate = 44.1 * 1000;
    var sec = samplingRate;
    var amp = 1 / 2;
    var rampThres = samplingRate * 0.05;
    Math.TAU = Math.PI * 2;
    const n = {
        "C": [16.35, 32.70, 65.41, 130.81, 261.63, 523.25, 1046.50, 2093.00, 4186.01],
        "Db": [17.32, 34.65, 69.30, 138.59, 277.18, 554.37, 1108.73, 2217.46, 4434.92],
        "D": [18.35, 36.71, 73.42, 146.83, 293.66, 587.33, 1174.66, 2349.32, 4698.64],
        "Eb": [19.45, 38.89, 77.78, 155.56, 311.13, 622.25, 1244.51, 2489.02, 4978.03],
        "E": [20.60, 41.20, 82.41, 164.81, 329.63, 659.26, 1318.51, 2637.02],
        "F": [21.83, 43.65, 87.31, 174.61, 349.23, 698.46, 1396.91, 2793.83],
        "Gb": [23.12, 46.25, 92.50, 185.00, 369.99, 739.99, 1479.98, 2959.96],
        "G": [24.50, 49.00, 98.00, 196.00, 392.00, 783.99, 1567.98, 3135.96],
        "Ab": [25.96, 51.91, 103.83, 207.65, 415.30, 830.61, 1661.22, 3322.44],
        "A": [27.50, 55.00, 110.00, 220.00, 440.00, 880.00, 1760.00, 3520.00],
        "Bb": [29.14, 58.27, 116.54, 233.08, 466.16, 932.33, 1864.66, 3729.31],
        "B": [30.87, 61.74, 123.47, 246.94, 493.88, 987.77, 1975.53, 3951.07]
    }
    var music = [
        [293.665, 0.4],
        [293.665, 0.4],
        [293.665 * 2, 0.8],
        [440, 1.6],
        [415.30, 0.8],
        [392.00, 0.8],
        [349.23, 0.8],
        [293.66, 0.4],
        [349.23, 0.4],
        [392.00, 0.4]
    ]

    var music2 = [
        [293.665 / 2, 0.8],
        [293.665 / 2, 0.4],
        [293.665 / 2, 0.4],
        [293.665 / 2, 0.4],
        [293.665 / 2, 0.8],
        [293.665 / 2, 0.4],
        [293.665 / 2, 0.4]
    ]

    var music3 = [
        [n.Ab[5], 1.2],
        [n.Gb[5], 0.4],
        [n.Ab[5], 1.2],
        [n.Gb[5], 0.4],
        [n.Db[5], 1.2],
        [n.B[4], 0.4],
        [n.Db[5], 1.2],
        [n.Db[5], 0.2],
        [n.D[5], 0.2],
        [n.E[5], 1.2],
        [n.D[5], 0.4],
        [n.E[5], 1.2],
        [n.D[5], 0.4],
        [n.B[4], 1.2],
        [n.A[4], 0.4],
        [n.B[4], 1.2],
        [n.Db[5], 0.2],
        [n.B[4], 0.2],
        [n.A[4], 0.8],
        [n.Db[5], 0.8],
        [n.Ab[5], 0.8],
        [n.A[5], 0.8],
        [n.B[5], 0.8],
        [n.Gb[5], 0.8],
        [n.Ab[5], 0.8],
        [n.A[5], 0.8],
        [n.Db[6], 1.6],
        [n.B[5], 0.2],
        [n.A[5], 0.2],
        [n.Db[6], 1.6],
        [n.B[5], 0.2],
        [n.A[5], 0.2],
        [n.Ab[5], 1.2],
        [n.Ab[5], 1.2],
        [n.Gb[5], 0.4],
        [n.Ab[5], 0.4],
        [n.A[4], 0.4],
        [n.Db[5], 0.4],
        [n.A[5], 0.4],
        [n.Ab[5], 0.2],
        [n.A[5], 0.2],
        [n.Ab[5], 1.2],
        [n.Gb[5], 0.4],
        [n.Ab[5], 1.2],
        [n.Ab[5], 0.2],
        [n.A[5], 0.2],
        [n.B[5], 1.2],
        [n.A[5], 0.4],
        [n.Ab[5], 0.4],
        [n.Gb[5], 0.4],
        [n.E[5], 0.4],
        [n.Gb[5], 0.4],
        [n.E[5], 0.2],
        [n.Gb[5], 0.2],
        [n.E[5], 0.4],
        [n.D[5], 0.4],
        [n.Db[5], 0.4],
        [n.B[4], 0.4],
        [n.Db[5], 0.4],
        [n.F[5], 0.4],
        [n.Ab[5], 0.4],
        [n.B[5], 0.4],
        [n.A[5], 0.8],
        [n.Db[6], 0.8],
        [n.Ab[6], 0.8],
        [n.A[6], 0.8],
        [n.Ab[6], 0.2],
        [n.A[6], 0.2],
        [n.Ab[6], 0.8],
        [n.Gb[6], 0.4],
        [n.E[6], 0.4],
        [n.D[6], 0.4],
        [n.Db[6], 0.4],
        [n.D[6], 0.4],
        [n.Gb[6], 2],
        [n.Gb[6], 0.2],
        [n.Ab[6], 0.2],
        [n.A[6], 0.8],
        [n.Ab[6], 0.2],
        [n.Gb[6], 0.2],
        [n.F[6], 1.6]
    ]

    var music4 = [
        [n.E[3], 0.4],
        [n.B[3], 0.8],
        [n.B[3], 0.4],
        [n.E[3], 0.4],
        [n.B[3], 0.4],
        [n.B[2], 0.4]
    ]


    function clamp(min, max, val) {
        return Math.min(Math.max(val, min), max);
    }

    function rendTrack(m) {
        var a = [];
        var mult = 126 * amp;
        m.forEach(note => {
            var duration = note[1] * sec;
            //var z = 1 / (note[0] / samplingRate);
            var c = Math.TAU * (note[0] / samplingRate);
            for (var i = 0; i < duration; i += 1 / 4) {
                var r = Math.sin(c * i) * mult;
                //r *= Math.min(2 * Math.sin(Math.PI * (i / duration)), 1)

                if (i < rampThres) { // (r)amping up 
                    var x = i / rampThres
                    r *= x;
                } else if (i > duration - rampThres) { // I hate this
                    var timeOver = i - (duration - rampThres);
                    r *= (rampThres - timeOver) / rampThres;
                }
                r = Math.round(r);
                a.push(r);
            }
        })
        return a;
    }

    function rendMultiTracks(tracks) {
        var rended = tracks.map(rendTrack);
        var lens = tracks.map(x => x.length).reduce((a, c) => a = Math.max(a, c));
        var r = new Array(lens);
        for (var i = 0; i < rended.length; i++) {
            for (var j = 0; j < rended[i].length; j++) {
                if (r[j] !== null && r[j] !== undefined) {
                    r[j] += rended[i][j];
                } else if (rended[i][j] !== null && rended[i][j] !== undefined) {
                    r[j] = rended[i][j];
                } else {
                    r[j] = 0;
                }
            }
        }
        for (var i = 0; i < r.length; i++) {
            r[i] = clamp(-125, 125, (r[i] / tracks.length))
        }
        return r;
    }

    function createBlob(a) {
        var header = buildWaveHeader({
            numFrames: a.length / 2,
            numChannels: 2
        }, a)
        return new Blob([header])
    }

    // https://ccrma.stanford.edu/courses/422/projects/WaveFormat/
    // https://gist.github.com/also/900023
    function buildWaveHeader(opts, stuff) {
        var numFrames = opts.numFrames;
        var numChannels = opts.numChannels || 2;
        var sampleRate = opts.sampleRate || 44100;
        var bytesPerSample = opts.bytesPerSample || 2;
        var blockAlign = numChannels * bytesPerSample;
        var byteRate = sampleRate * blockAlign;
        var dataSize = numFrames * blockAlign;
        var buffer = new ArrayBuffer(44 + dataSize);
        var dv = new DataView(buffer);
        var p = 0;

        function writeString(s) {
            for (var i = 0; i < s.length; i++) {
                dv.setUint8(p + i, s.charCodeAt(i));
            }
            p += s.length;
        }

        function writeUint32(d) {
            dv.setUint32(p, d, true);
            p += 4;
        }

        function writeInt8(d) {
            dv.setInt8(p, d, true);
            p += 1;
        }


        function writeUint16(d) {
            dv.setUint16(p, d, true);
            p += 2;
        }

        writeString('RIFF'); // ChunkID
        writeUint32(dataSize + 36); // ChunkSize
        writeString('WAVE'); // Format
        writeString('fmt '); // Subchunk1ID
        writeUint32(16); // Subchunk1Size
        writeUint16(1); // AudioFormat
        writeUint16(numChannels); // NumChannels
        writeUint32(sampleRate); // SampleRate
        writeUint32(byteRate); // ByteRate
        writeUint16(blockAlign); // BlockAlign
        writeUint16(bytesPerSample * 8); // BitsPerSample
        writeString('data'); // Subchunk2ID
        writeUint32(dataSize); // Subchunk2Size
        stuff.map(x => writeInt8(x));
        return buffer;
    }
    document.getElementById('play').onclick = function(event) {
        var url = window.URL.createObjectURL(preloaded);
        var aud = new window.Audio();
        aud.src = url;
        aud.play();
    }
    document.getElementById('myButton').onclick = function(event) {
        var url = window.URL.createObjectURL(preloaded);
        this.href = url;
        this.target = '_blank';
        this.download = 'avg.wav';
    }
    console.time();
    var preloaded = createBlob(rendMultiTracks([music3]));
    console.timeEnd();
</script>
